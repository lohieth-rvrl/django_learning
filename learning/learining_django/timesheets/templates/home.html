{% extends "ui/index.html" %}
{% load static %}

{% block title %}Timesheet List{% endblock %}

{% block show %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1>Timesheets</h1>
  <button class="btn btn-primary btn-sm create-btn" data-bs-toggle="modal" data-bs-target="#createTimesheetModal">
    Create
  </button>
</div>

<div class="table-responsive">
  <table class="table table-striped table-hover align-middle border shadow-sm">
    <thead class="table-dark">
      <tr>
        <th>Project</th>
        <th>Module</th>
        <th>Task</th>
        <th class="text-end">Hours</th>
        <th>Description</th>
        <th class="text-center">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for t in data %}
      <tr>
        <td>{{ t.project }}</td>
        <td>{{ t.module }}</td>
        <td>{{ t.task }}</td>
        <td class="text-end">{{ t.time }}</td>
        <td>{{ t.description }}</td>
        <td class="text-center">
          <button
            class="btn btn-sm btn-secondary edit-btn"
            data-bs-toggle="modal"
            data-bs-target="#createTimesheetModal"
            data-id="{{ t.id }}"
            data-project="{{ t.project.id }}"
            data-module="{{ t.module.id }}"
            data-task="{{ t.task.id }}"
            data-date="{{ t.date|date:'Y-m-d' }}"
            data-time="{{ t.time }}"
            data-description="{{ t.description }}"
          >
            Edit
          </button>
          <form action="{% url 'sheetdelete' t.id %}" method="post" class="delete-form" data-id="{{ t.id }}">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="text-center text-muted py-4">No timesheets available.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="createTimesheetModal" tabindex="-1" aria-labelledby="createTimesheetModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white">
        <h5 class="modal-title" id="createTimesheetModalLabel">Create Timesheet</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="timesheetForm" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <!-- _method field will be added dynamically for edit -->
          {{ form.as_p }}
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Save</button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).ready(function () {
    // CREATE button resets form
    $('.create-btn').on('click', function () {
      $('#createTimesheetModalLabel').text('Create Timesheet');
      $('#timesheetForm').attr('action', '{% url "sheetcreate" %}');
      $('#timesheetForm').data('method', 'POST');
      $('#timesheetForm').find('input[name="_method"]').remove(); // remove override
      $('#timesheetForm')[0].reset();
    });

    // EDIT button populates form
    $('.edit-btn').on('click', function () {
      const btn = $(this);
      const id = btn.data('id');

      $('#createTimesheetModalLabel').text('Edit Timesheet');
      $('#timesheetForm').attr('action', `/timesheets/edit/${id}/`);
      {% comment %} $('#timesheetForm').attr('action', '{% url "sheetedit" id %}'); {% endcomment %}
      $('#timesheetForm').data('method', 'PUT');

      // Add hidden _method field
      if ($('#timesheetForm input[name="_method"]').length === 0) {
        $('#timesheetForm').prepend('<input type="hidden" name="_method" value="PUT">');
      }

      $('#id_project').val(btn.data('project')).trigger('change');
      setTimeout(function () {
        $('#id_module').val(btn.data('module')).trigger('change');

        setTimeout(function () {
          $('#id_task').val(btn.data('task'));
        }, 300);
      }, 300);
      $('#id_date').val(btn.data('date'));
      $('#id_time').val(btn.data('time'));
      $('#id_description').val(btn.data('description'));
    });

    // AJAX submit for create/edit
    $('#timesheetForm').on('submit', function (e) {
      e.preventDefault();

      const form = $(this);
      const url = form.attr('action');
      const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();
      const formData = new FormData(this);

      $.ajax({
        url: url,
        type: 'POST', // always POST
        data: formData,
        processData: false,
        contentType: false,
        headers: {
          'X-CSRFToken': csrfToken
        },
        success: function () {
          $('#createTimesheetModal').modal('hide');
          location.reload();
        },
        error: function (xhr) {
          alert('Error: ' + xhr.responseText);
        }
      });
    });

    // AJAX delete
    $('.delete-form').on('submit', function (e) {
      e.preventDefault();

      const form = $(this);
      const url = form.attr('action');
      const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();

      if (confirm('Are you sure you want to delete this item?')) {
        $.ajax({
          url: url,
          type: 'DELETE',
          headers: {
            'X-CSRFToken': csrfToken
          },
          success: function () {
            form.closest('tr').fadeOut();
            alert('Deleted successfully!');
          },
          error: function () {
            alert('Error deleting item.');
          }
        });
      }
    });
  });
</script>
{% comment %} <script>
  $('#id_project').change(function () {
    const projectId = $(this).val();
    $.ajax({
      url: '/home/timesheets/ajax/load-modules/',
      data: {
        'project': projectId
      },
      success: function (data) {
        $('#id_module').empty();
        $('#id_task').empty();
        $('#id_module').append('<option value="">---------</option>');
        data.forEach(function (module) {
          $('#id_module').append(`<option value="${module.id}">${module.name}</option>`);
        });
      }
    });
  });

  $('#id_module').change(function () {
    const moduleId = $(this).val();
    $.ajax({
      url: '/home/timesheets/ajax/load-tasks/',
      data: {
        'module': moduleId
      },
      success: function (data) {
        $('#id_task').empty();
        $('#id_task').append('<option value="">---------</option>');
        data.forEach(function (task) {
          $('#id_task').append(`<option value="${task.id}">${task.name}</option>`);
        });
      }
    });
  });
</script> {% endcomment %}
{% endblock %}