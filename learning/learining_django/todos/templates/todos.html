{% extends "ui/index.html" %}
{% load static %}

{% block title %}Timesheet List{% endblock %}

{% block show %}
<div class="page-heading d-flex justify-content-between align-items-center">
    <h3>Todo Maker</h3>
    <button href="#" class="btn btn-sm btn-primary sidebar-link create-btn" data-bs-toggle="modal"
        data-bs-target="#createTodoModal">
        <span>Create</span>
    </button>
</div>

<div class="page-content">
    <section class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-3">
                            <input type="text" id="searchInput" class="form-control" placeholder="Search">
                        </div>
                        <div class="col-md-3">
                            <select id="statusFilter" class="form-select">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select id="priorityFilter" class="form-select">
                                <option value="">All Priority</option>
                                <option value="Low">Low</option>
                                <option value="Medium">Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="card-body">
                    <div class="table-responsive" id="todoTableContainer">
                        <table class="table table-striped table-hover align-middle border shadow-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Title</th>
                                    <th>Description</th>
                                    <th>Priority</th>
                                    <th>Due Date</th>
                                    <th>Status</th>
                                    <th class="w-25">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="todoTableBody">
                                {% if todos %}
                                {% for todo in todos %}
                                <tr>
                                    <td>{{ todo.title }}</td>
                                    <td>{{ todo.description }}</td>
                                    {% if todo.priority == 'Low' %}
                                    <td class="text-warning">{{ todo.priority }}</td>
                                    {% elif todo.priority == 'Medium' %}
                                    <td class="text-info">{{ todo.priority }}</td>
                                    {% else %}
                                    <td class="text-danger">{{ todo.priority }}</td>
                                    {% endif %}
                                    <td>{{ todo.date }}</td>
                                    {% if todo.status == 'Pending' %}
                                    <td class="text-warning t-status">{{ todo.status }}</td>
                                    {% elif todo.status == 'In Progress' %}
                                    <td class="text-info t-status">{{ todo.status }}</td>
                                    {% else %}
                                    <td class="text-success t-status">{{ todo.status }}</td>
                                    {% endif %}
                                    <td class="text-center d-flex flex-column p-3">
                                        <button class="btn btn-sm btn-secondary edit-btn" data-bs-toggle="modal"
                                            data-bs-target="#createTodoModal" data-id="{{ todo.id }}"
                                            data-title="{{ todo.title }}" data-description="{{ todo.description }}"
                                            data-priority="{{ todo.priority }}" data-date="{{ todo.date|date:'Y-m-d' }}"
                                            data-status="{{ todo.status }}">
                                            Edit
                                        </button>
                                        <p>
                                        <form method="post" action="{% url 'tododelete' todo.id %}"
                                            class="delete-form d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger btn-sm w-100">Delete</button>
                                        </form>
                                        </p>
                                        {% if todo.status != 'Completed' %}
                                        <button class="btn btn-success btn-sm completeBtn"
                                            data-id="{{ todo.id }}">Complete</button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">No todos available.</td>
                                </tr>
                                {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>

<div class="modal fade" id="createTodoModal" tabindex="-1" aria-labelledby="createTodoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="createTodoModalLabel">Create Todo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body px-5">
                <form id="todoForm" method="post">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<footer class="main-footer">
    <div class="footer clearfix mb-0 text-muted">
        <div class="float-start">
            <p>-> Footer Section</p>
        </div>
    </div>
</footer>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('.create-btn').on('click', function () {
            $('#createTodoModalLabel').text('Create Todo');
            $('#todoForm').attr('action', '{% url "todocreate" %}');
            $('#todoForm')[0].reset();
        });

        $('.edit-btn').on('click', function () {
            const btn = $(this);
            const id = btn.data('id');
            $('#createTodoModalLabel').text('Edit Todo');
            $('#todoForm').attr('action', `/todos/edit/${id}/`);
            $('#id_title').val(btn.data('title'));
            $('#id_description').val(btn.data('description'));
            $('#id_priority').val(btn.data('priority'));
            $('#id_date').val(btn.data('date'));
            $('#id_status').val(btn.data('status'));
        });

        $('#todoForm').on('submit', function (e) {
            e.preventDefault();
            const form = $(this);
            const url = form.attr('action');
            const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();
            const formData = new FormData(this);
            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: { 'X-CSRFToken': csrfToken },
                success: function () {
                    $('#createTodoModal').modal('hide');
                    loadFilteredData();
                },
                error: function (xhr) {
                    alert('Error: ' + xhr.responseText);
                }
            });
        });

        $(document).on('submit', '.delete-form', function (e) {
            e.preventDefault();
            const form = $(this);
            const url = form.attr('action');
            const csrfToken = form.find('input[name="csrfmiddlewaretoken"]').val();
            if (confirm('Are you sure you want to delete this item?')) {
                $.ajax({
                    url: url,
                    type: 'POST',
                    headers: { 'X-CSRFToken': csrfToken },
                    success: function () {
                        form.closest('tr').fadeOut();
                    },
                    error: function () {
                        alert('Error deleting item.');
                    }
                });
            }
        });

        $(document).on('click', '.completeBtn', function (e) {
            e.preventDefault();
            const id = $(this).data('id');
            const btn = $(this);
            $.ajax({
                url: `/todos/complete/${id}/`,
                type: 'POST',
                data: { csrfmiddlewaretoken: '{{ csrf_token }}' },
                success: function (res) {
                    if (res.status === 'success') {
                        const row = btn.closest('tr');
                        const statusCell = row.find('.t-status');
                        statusCell.text('Completed');
                        btn.remove();
                    }
                },
                error: function (err) {
                    console.log('Error marking complete:', err);
                }
            });
        });

        function loadFilteredData() {
            const query = $('#searchInput').val();
            const status = $('#statusFilter').val();
            const priority = $('#priorityFilter').val();
            $.get(`?search=${query}&status=${status}&priority=${priority}`, function (data) {
                const newTable = $(data).find('#todoTableBody').html();
                $('#todoTableBody').html(newTable);
            });
        }

        $('#searchInput, #statusFilter, #priorityFilter').on('input change', function () {
            loadFilteredData();
        });
    });
</script>

{% endblock %}